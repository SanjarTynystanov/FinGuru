const translations = {
    ru: {
        'budget-title': 'FinGuru – Умный бюджет',
        'budget-subtitle': 'Контролируйте свои финансы и достигайте целей с лёгкостью',
        'budget-info': 'Здесь вы можете управлять своим бюджетом: указать доходы, рассчитать расходы вручную или загрузить их из банка, установить финансовые цели.',
        'budget-input-title': 'Ваши финансы',
        'income-label': 'Доходы ({currency}):',
        'manual-expenses-title': 'Ручной расчет расходов',
        'expense-rent': 'Аренда:',
        'expense-food': 'Еда:',
        'expense-utilities': 'Коммунальные услуги:',
        'expense-other': 'Прочее:',
        'calculate-manual': 'Рассчитать вручную',
        'bank-expenses-title': 'Расчет из банка',
        'fetch-expenses': 'Загрузить из банка',
        'calculate-total': 'Рассчитать общий баланс',
        'balance-result': 'Остаток: {amount} {currency}',
        'reset-data': 'Сбросить данные',
        'goal-title': 'Финансовые цели',
        'goal-amount': 'Сумма ({currency}):',
        'goal-name': 'Название цели:',
        'goal-period': 'Срок (месяцев):',
        'goal-priority': 'Приоритет:',
        'set-goal': 'Установить цель',
        'progress-text': 'Прогресс: {progress}%',
        'forecast-result': 'Для достижения цели нужно откладывать {amount} {currency} в месяц за {period} месяцев.',
        'forecast-period': 'Период прогноза:',
        'goal-tips-title': 'Советы по достижению целей',
        'goal-tip-1': 'Откладывайте 10-20% дохода ежемесячно.',
        'goal-tip-2': 'Сократите необязательные расходы.',
        'goal-tip-3': 'Используйте автоматические переводы на сберегательный счет.',
        'chart-title': 'Обзор бюджета',
        'currency-toggle': 'Валюта: {currency}',
        'nav-home': 'Главная',
        'nav-features': 'Возможности',
        'nav-currency': 'Конвертер',
        'feature-budget-menu': 'Бюджет',
        'feature-dashboard-menu': 'Панель управления',
        'feature-goals-menu': 'Цели',
        'feature-forecast-menu': 'Прогноз',
        'feature-reminders-menu': 'Напоминания',
        'feature-tips-menu': 'Советы',
        'nav-banks': 'Банктар',
        'banks-connected': 'Подключённые',
        'banks-add': 'Добавить',
        'banks-settings': 'Настройки',
        'banks-faq': 'FAQ',
        'nav-analytics': 'Аналитика',
        'nav-faq': 'FAQ',
        'login': 'Войти',
        'logout': 'Выход',
        'register': 'Регистрация',
        'footer-about-title': 'О FinGuru',
        'footer-about-text': 'FinGuru - это ваш персональный финансовый помощник, разработанный, чтобы помочь вам легко управлять своими деньгами, отслеживать расходы и достигать финансовых целей.',
        'quick-links': 'Быстрые ссылки',
        'how-it-works': 'Как это работает',
        'testimonials': 'Отзывы',
        'cta': 'Начать',
        'contacts': 'Контакты',
        'phone': 'Телефон: +7 (123) 456-78-90',
        'social-telegram': 'Telegram',
        'social-vk': 'VK',
        'subscribe': 'Подписка',
        'subscribe-text': 'Получайте последние новости и обновления',
        'subscribe-btn': 'Подписаться',
        'privacy-policy': 'Политика конфиденциальности',
        'terms-of-use': 'Условия использования',
        'footer-copyright': '© 2025 FinGuru. Все права защищены.',
        'bank-connect-title': 'Подключение банков',
        'bank-select': 'Выберите банк:',
        'bank-account': 'Номер счёта:',
        'bank-connect-btn': 'Подключить',
        'bank-sync': 'Синхронизировать выписки',
        'auto-fill': 'Автозаполнить (10% дохода)',
        'save-data': 'Сохранить данные',
        'help-title': 'Справка',
        'help-text': 'Используйте эту страницу для управления бюджетом. Введите доходы и расходы, подключите банк для автоматического обновления данных, установите финансовые цели и отслеживайте прогресс.',
        'help-step-1': 'Введите доходы в поле "Доходы".',
        'help-step-2': 'Укажите расходы вручную или загрузите из банка.',
        'help-step-3': 'Нажмите "Рассчитать общий баланс" для анализа.',
        'help-step-4': 'Установите цель и следите за прогрессом.',
        'close': 'Закрыть',
        'help-btn': 'Справка',
        'error-invalid-input': 'Пожалуйста, введите корректные значения.',
        'success': 'успешно'
    },
    en: {
        'budget-title': 'FinGuru – Smart Budget',
        'budget-subtitle': 'Control your finances and achieve your goals with ease',
        'budget-info': 'Here you can manage your budget: enter your income, calculate expenses manually or load them from your bank, and set financial goals.',
        'budget-input-title': 'Your Finances',
        'income-label': 'Income ({currency}):',
        'manual-expenses-title': 'Manual Expense Calculation',
        'expense-rent': 'Rent:',
        'expense-food': 'Food:',
        'expense-utilities': 'Utilities:',
        'expense-other': 'Other:',
        'calculate-manual': 'Calculate Manually',
        'bank-expenses-title': 'Bank Expense Calculation',
        'fetch-expenses': 'Load from Bank',
        'calculate-total': 'Calculate Total Balance',
        'balance-result': 'Balance: {amount} {currency}',
        'reset-data': 'Reset Data',
        'goal-title': 'Financial Goals',
        'goal-amount': 'Amount ({currency}):',
        'goal-name': 'Goal Name:',
        'goal-period': 'Period (months):',
        'goal-priority': 'Priority:',
        'set-goal': 'Set Goal',
        'progress-text': 'Progress: {progress}%',
        'forecast-result': 'To achieve your goal, save {amount} {currency} per month for {period} months.',
        'forecast-period': 'Forecast Period:',
        'goal-tips-title': 'Tips for Achieving Goals',
        'goal-tip-1': 'Save 10-20% of your income monthly.',
        'goal-tip-2': 'Cut unnecessary expenses.',
        'goal-tip-3': 'Use automatic transfers to a savings account.',
        'chart-title': 'Budget Overview',
        'currency-toggle': 'Currency: {currency}',
        'nav-home': 'Home',
        'nav-features': 'Features',
        'nav-currency': 'Converter',
        'feature-budget-menu': 'Budget',
        'feature-dashboard-menu': 'Dashboard',
        'feature-goals-menu': 'Goals',
        'feature-forecast-menu': 'Forecast',
        'feature-reminders-menu': 'Reminders',
        'feature-tips-menu': 'Tips',
        'nav-banks': 'Banks',
        'banks-connected': 'Connected',
        'banks-add': 'Add',
        'banks-settings': 'Settings',
        'banks-faq': 'FAQ',
        'nav-analytics': 'Analytics',
        'nav-faq': 'FAQ',
        'login': 'Login',
        'logout': 'Logout',
        'register': 'Register',
        'footer-about-title': 'About FinGuru',
        'footer-about-text': 'FinGuru is your personal financial assistant, designed to help you manage your money, track expenses, and achieve your financial goals with ease.',
        'quick-links': 'Quick Links',
        'how-it-works': 'How It Works',
        'testimonials': 'Testimonials',
        'cta': 'Get Started',
        'contacts': 'Contacts',
        'phone': 'Phone: +7 (123) 456-78-90',
        'social-telegram': 'Telegram',
        'social-vk': 'VK',
        'subscribe': 'Subscribe',
        'subscribe-text': 'Get the latest news and updates',
        'subscribe-btn': 'Subscribe',
        'privacy-policy': 'Privacy Policy',
        'terms-of-use': 'Terms of Use',
        'footer-copyright': '© 2025 FinGuru. All rights reserved.',
        'bank-connect-title': 'Bank Connection',
        'bank-select': 'Select Bank:',
        'bank-account': 'Account Number:',
        'bank-connect-btn': 'Connect',
        'bank-sync': 'Sync Statements',
        'auto-fill': 'Auto-fill (10% of income)',
        'save-data': 'Save Data',
        'help-title': 'Help',
        'help-text': 'Use this page to manage your budget. Enter your income and expenses, connect your bank for automatic data updates, and set financial goals.',
        'help-step-1': 'Enter your income in the "Income" field.',
        'help-step-2': 'Specify expenses manually or load from your bank.',
        'help-step-3': 'Click "Calculate Total Balance" to analyze.',
        'help-step-4': 'Set a goal and track your progress.',
        'close': 'Close',
        'help-btn': 'Help',
        'error-invalid-input': 'Please enter valid values.',
        'success': 'successfully'
    },
    ky: {
        'budget-title': 'FinGuru – Акылдуу бюджет',
        'budget-subtitle': 'Каржыңызды көзөмөлдөңүз жана максаттарыңызга оңой жетиңиз',
        'budget-info': 'Бул жерде сиз бюджетиңизди башкара аласыз: кирешеңизди киргизиңиз, чыгымдарды кол менен эсептеңиз же банктан жүктөңүз, каржы максаттарын коюңуз.',
        'budget-input-title': 'Сиздин каржыңыз',
        'income-label': 'Киреше ({currency}):',
        'manual-expenses-title': 'Чыгымдарды кол менен эсептөө',
        'expense-rent': 'Ижара:',
        'expense-food': 'Тамак-аш:',
        'expense-utilities': 'Коммуналдык кызматтар:',
        'expense-other': 'Башка:',
        'calculate-manual': 'Кол менен эсептөө',
        'bank-expenses-title': 'Банктан эсептөө',
        'fetch-expenses': 'Банктан жүктөө',
        'calculate-total': 'Жалпы балансты эсептөө',
        'balance-result': 'Калдык: {amount} {currency}',
        'reset-data': 'Маалыматты тазалоо',
        'goal-title': 'Каржы максаттары',
        'goal-amount': 'Сумма ({currency}):',
        'goal-name': 'Максаттын аты:',
        'goal-period': 'Мөөнөт (айлар):',
        'goal-priority': 'Приоритет:',
        'set-goal': 'Максат коюу',
        'progress-text': 'Прогресс: {progress}%',
        'forecast-result': 'Максатка жетиүү үчүн айына {amount} {currency} топтоо керек {period} айга.',
        'forecast-period': 'Прогноз мөөнөтү:',
        'goal-tips-title': 'Максаттарга жетүү боюнча кеңештер',
        'goal-tip-1': 'Кирешеңиздин 10-20% ай сайын топтоңуз.',
        'goal-tip-2': 'Керексиз чыгымдарды кыскартыңыз.',
        'goal-tip-3': 'Сактык эсебине автоматтык которууларды колдонуңуз.',
        'chart-title': 'Бюджеттин обзору',
        'currency-toggle': 'Валюта: {currency}',
        'nav-home': 'Башкы бет',
        'nav-features': 'Мүмкүнчүлүктөр',
        'nav-currency': 'Конвертер',
        'feature-budget-menu': 'Бюджет',
        'feature-dashboard-menu': 'Башкаруу панели',
        'feature-goals-menu': 'Максаттар',
        'feature-forecast-menu': 'Болжолдоо',
        'feature-reminders-menu': 'Эскертмелер',
        'feature-tips-menu': 'Кеңештер',
        'nav-banks': 'Банктар',
        'banks-connected': 'Туташкан',
        'banks-add': 'Кошуу',
        'banks-settings': 'Жөндөөлөр',
        'banks-faq': 'FAQ',
        'nav-analytics': 'Аналитика',
        'nav-faq': 'Сурактар',
        'login': 'Кирүү',
        'logout': 'Чыгуу',
        'register': 'Катталуу',
        'footer-about-title': 'FinGuru жөнүндө',
        'footer-about-text': 'FinGuru - бул сиздин жеке каржы жардамчыңыз, ал сизге акчаңызды оңой башкарууга, чыгымдарды көзөмөлдөөгө жана каржы максаттарыңызга жетиүүгө жардам берет.',
        'quick-links': 'Тез шилтемелер',
        'how-it-works': 'Бул кантип иштейт',
        'testimonials': 'Пикирлер',
        'cta': 'Баштоо',
        'contacts': 'Байланыш',
        'phone': 'Телефон: +7 (123) 456-78-90',
        'social-telegram': 'Telegram',
        'social-vk': 'VK',
        'subscribe': 'Жазылуу',
        'subscribe-text': 'Акыркы жаңылыктарды жана жаңыртууларды алыңыз',
        'subscribe-btn': 'Жазылуу',
        'privacy-policy': 'Жеке маалымат саясаты',
        'terms-of-use': 'Колдонуу шарттары',
        'footer-copyright': '© 2025 FinGuru. Бардык укуктар корголгон.',
        'bank-connect-title': 'Банкты туташтыруу',
        'bank-select': 'Банкты тандаңыз:',
        'bank-account': 'Эсеп номери:',
        'bank-connect-btn': 'Туташтыруу',
        'bank-sync': 'Арыздарды синхрондоштуруу',
        'auto-fill': 'Автозаполнить (10% дохода)',
        'save-data': 'Сохранить данные',
        'help-title': 'Справка',
        'help-text': 'Используйте эту страницу для управления бюджетом. Введите доходы и расходы, подключите банк для автоматического обновления данных, установите финансовые цели и отслеживайте прогресс.',
        'help-step-1': 'Введите доходы в поле "Доходы".',
        'help-step-2': 'Укажите расходы вручную или загрузите из банка.',
        'help-step-3': 'Нажмите "Рассчитать общий баланс" для анализа.',
        'help-step-4': 'Установите цель и следите за прогрессом.',
        'close': 'Закрыть',
        'help-btn': 'Справка',
        'error-invalid-input': 'Пожалуйста, введите корректные значения.',
        'success': 'успешно'
    }
};

let currentLang = localStorage.getItem('language') || 'ru';
let currentTheme = localStorage.getItem('theme') || 'light';
let currentCurrency = localStorage.getItem('currency') || 'RUB';
const exchangeRate = { RUB_TO_KGS: 1.1234, KGS_TO_RUB: 0.8901 };

function updateLanguageAndCurrency() {
    document.querySelectorAll('[data-lang-key]').forEach(el => {
        const key = el.dataset.langKey;
        if (key && translations[currentLang][key]) {
            let text = translations[currentLang][key];
            text = text.replace('{currency}', currentCurrency);
            if (key === 'balance-result') {
                text = text.replace('{amount}', el.dataset.amount ? formatAmount(parseFloat(el.dataset.amount)) : '0');
            } else if (key === 'progress-text') {
                text = text.replace('{progress}', el.dataset.progress || '0');
            } else if (key === 'forecast-result') {
                text = text.replace('{amount}', el.dataset.amount ? formatAmount(parseFloat(el.dataset.amount)) : '0');
                text = text.replace('{period}', el.dataset.period || '1');
            } else if (key === 'currency-toggle') {
                text = text.replace('{currency}', currentCurrency);
            }
            el.textContent = text;
        }
    });
    document.documentElement.lang = currentLang;
}

function applyTheme() {
    console.log('Applying theme:', currentTheme);
    const body = document.body;
    if (currentTheme === 'dark') {
        body.classList.add('dark-theme');
        body.classList.remove('light-theme');
    } else {
        body.classList.add('light-theme');
        body.classList.remove('dark-theme');
    }
    localStorage.setItem('theme', currentTheme);
}

function convertToCurrentCurrency(amount) {
    return currentCurrency === 'KGS' ? (amount * exchangeRate.RUB_TO_KGS).toFixed(2) : (amount * exchangeRate.KGS_TO_RUB).toFixed(2);
}

function formatAmount(amount) {
    return Number(convertToCurrentCurrency(amount)).toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function validateInputs(inputs) {
    let isValid = true;
    inputs.forEach(input => {
        if (!input.value || parseFloat(input.value) < 0) {
            input.classList.add('is-invalid');
            isValid = false;
        } else {
            input.classList.remove('is-invalid');
        }
    });
    return isValid;
}

function showError(message) {
    alert(message || translations[currentLang]['error-invalid-input']);
}

document.addEventListener('DOMContentLoaded', () => {
    window.translations = translations;
    window.currentLang = currentLang;
    window.currentTheme = currentTheme;
    window.currentCurrency = currentCurrency;
    window.exchangeRate = exchangeRate;
    window.updateLanguageAndCurrency = updateLanguageAndCurrency;
    window.applyTheme = applyTheme;
    window.convertToCurrentCurrency = convertToCurrentCurrency;
    window.formatAmount = formatAmount;

    applyTheme();
    updateLanguageAndCurrency();

    const budgetData = {
        transactions: JSON.parse(localStorage.getItem('budgetTransactions')) || [],
        accounts: JSON.parse(localStorage.getItem('budgetAccounts')) || [],
        addTransaction: function(type, amount, category, date) {
            const amountInRUB = currentCurrency === 'KGS' ? amount / exchangeRate.RUB_TO_KGS : amount;
            this.transactions.push({ type, amount: amountInRUB, category, id: Date.now(), date: date || new Date() });
            localStorage.setItem('budgetTransactions', JSON.stringify(this.transactions));
        },
        addAccount: function(bank, accountNumber) {
            this.accounts.push({ bank, accountNumber, connected: false, lastSync: null });
            localStorage.setItem('budgetAccounts', JSON.stringify(this.accounts));
        },
        getTransactions: function() {
            return this.transactions.map(tx => ({
                ...tx,
                amount: currentCurrency === 'KGS' ? tx.amount * exchangeRate.RUB_TO_KGS : tx.amount
            }));
        },
        clearData: function() {
            this.transactions = [];
            this.accounts = [];
            localStorage.removeItem('budgetTransactions');
            localStorage.removeItem('budgetAccounts');
        }
    };

    // Тестовые данные
    budgetData.addTransaction('income', 50000, 'income', new Date());
    budgetData.addTransaction('expense', 20000, 'rent', new Date());
    budgetData.addTransaction('expense', 10000, 'food', new Date());
    budgetData.addTransaction('expense', 5000, 'utilities', new Date());
    budgetData.addTransaction('expense', 5000, 'other', new Date());

    let budgetChart = null;
    const ctxBudget = document.getElementById('budget-total-chart')?.getContext('2d');
    if (ctxBudget) {
        budgetChart = new Chart(ctxBudget, {
            type: 'doughnut',
            data: {
                labels: [
                    translations[currentLang]['income-label'].replace(' ({currency}):', ''),
                    translations[currentLang]['manual-expenses-title'],
                    translations[currentLang]['balance-result'].split(':')[0]
                ],
                datasets: [{
                    data: [50000, 40000, 10000],
                    backgroundColor: ['#4a90e2', '#ff6384', '#4bc0c0'],
                    borderWidth: 1,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom', labels: { color: currentTheme === 'dark' ? '#f0f0f0' : '#333' } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${formatAmount(context.raw)} ${currentCurrency}`;
                            }
                        },
                        bodyColor: currentTheme === 'dark' ? '#f0f0f0' : '#333'
                    }
                },
                cutout: '50%'
            }
        });
    }

    const incomeInput = document.getElementById('income');
    const expenseRentInput = document.getElementById('expense-rent');
    const expenseFoodInput = document.getElementById('expense-food');
    const expenseUtilitiesInput = document.getElementById('expense-utilities');
    const expenseOtherInput = document.getElementById('expense-other');
    const expenseBankInput = document.getElementById('expense-bank');
    const fetchExpensesBtn = document.getElementById('fetchExpenses');
    const calculateManualBtn = document.getElementById('calculateManual');
    const calculateTotalBtn = document.getElementById('calculateTotal');
    const balanceResult = document.getElementById('balanceResult');
    const resetDataBtn = document.getElementById('resetData');
    const goalAmountInput = document.getElementById('goalAmount');
    const goalNameInput = document.getElementById('goalName');
    const goalPeriodInput = document.getElementById('goalPeriod');
    const goalPriorityInput = document.getElementById('goalPriority');
    const setGoalBtn = document.getElementById('setGoal');
    const goalProgressBar = document.getElementById('goalProgressBar');
    const goalProgressText = document.getElementById('goalProgressText');
    const forecastResult = document.getElementById('forecastResult');
    const currencyToggleBtn = document.getElementById('currencyToggle');
    const bankConnectBtn = document.getElementById('bankConnect');
    const bankSelect = document.getElementById('bankSelect');
    const bankAccountInput = document.getElementById('bankAccount');
    const bankSyncBtn = document.getElementById('bankSync');
    const autoFillExpensesBtn = document.getElementById('autoFillExpenses');
    const saveDataBtn = document.getElementById('saveData');

    // Инициализация видимости
    document.querySelector('.budget-info').classList.add('visible');
    document.querySelectorAll('.card').forEach(card => card.classList.add('visible'));

    autoFillExpensesBtn.addEventListener('click', () => {
        const income = parseFloat(incomeInput.value) || 0;
        if (income > 0) {
            const expenseAmount = income * 0.10;
            expenseRentInput.value = (expenseAmount * 0.4).toFixed(2);
            expenseFoodInput.value = (expenseAmount * 0.3).toFixed(2);
            expenseUtilitiesInput.value = (expenseAmount * 0.2).toFixed(2);
            expenseOtherInput.value = (expenseAmount * 0.1).toFixed(2);
            alert(translations[currentLang]['auto-fill'] + ' ' + formatAmount(expenseAmount) + ' ' + currentCurrency);
        } else {
            showError();
        }
    });

    saveDataBtn.addEventListener('click', () => {
        const data = {
            income: incomeInput.value,
            expenses: {
                rent: expenseRentInput.value,
                food: expenseFoodInput.value,
                utilities: expenseUtilitiesInput.value,
                other: expenseOtherInput.value,
                bank: expenseBankInput.value
            },
            goal: {
                amount: goalAmountInput.value,
                name: goalNameInput.value,
                period: goalPeriodInput.value,
                priority: goalPriorityInput.value
            }
        };
        localStorage.setItem('budgetData', JSON.stringify(data));
        alert(translations[currentLang]['save-data'] + ' ' + translations[currentLang]['success']);
    });

    const savedData = JSON.parse(localStorage.getItem('budgetData'));
    if (savedData) {
        incomeInput.value = savedData.income || '';
        expenseRentInput.value = savedData.expenses?.rent || '';
        expenseFoodInput.value = savedData.expenses?.food || '';
        expenseUtilitiesInput.value = savedData.expenses?.utilities || '';
        expenseOtherInput.value = savedData.expenses?.other || '';
        expenseBankInput.value = savedData.expenses?.bank || '';
        goalAmountInput.value = savedData.goal?.amount || '';
        goalNameInput.value = savedData.goal?.name || '';
        goalPeriodInput.value = savedData.goal?.period || '';
        goalPriorityInput.value = savedData.goal?.priority || '';
    }

    calculateManualBtn.addEventListener('click', () => {
        const inputs = [expenseRentInput, expenseFoodInput, expenseUtilitiesInput, expenseOtherInput];
        if (!validateInputs(inputs)) return showError();
        const rent = parseFloat(expenseRentInput.value) || 0;
        const food = parseFloat(expenseFoodInput.value) || 0;
        const utilities = parseFloat(expenseUtilitiesInput.value) || 0;
        const other = parseFloat(expenseOtherInput.value) || 0;
        const totalExpenses = rent + food + utilities + other;

        budgetData.addTransaction('expense', rent, 'rent');
        budgetData.addTransaction('expense', food, 'food');
        budgetData.addTransaction('expense', utilities, 'utilities');
        budgetData.addTransaction('expense', other, 'other');

        alert(`${translations[currentLang]['manual-expenses-title']}: ${formatAmount(totalExpenses)} ${currentCurrency}`);
    });

    fetchExpensesBtn.addEventListener('click', () => {
        const mockBankExpenses = 15000;
        const convertedBankExpenses = convertToCurrentCurrency(mockBankExpenses);
        expenseBankInput.value = convertedBankExpenses;
        budgetData.addTransaction('expense', mockBankExpenses, 'bank');
        alert(`${translations[currentLang]['bank-expenses-title']}: ${formatAmount(mockBankExpenses)} ${currentCurrency}`);
    });

    calculateTotalBtn.addEventListener('click', () => {
        const inputs = [incomeInput, expenseRentInput, expenseFoodInput, expenseUtilitiesInput, expenseOtherInput, expenseBankInput];
        if (!validateInputs(inputs)) return showError();
        const income = parseFloat(incomeInput.value) || 0;
        const rent = parseFloat(expenseRentInput.value) || 0;
        const food = parseFloat(expenseFoodInput.value) || 0;
        const utilities = parseFloat(expenseUtilitiesInput.value) || 0;
        const other = parseFloat(expenseOtherInput.value) || 0;
        const bank = parseFloat(expenseBankInput.value) || 0;

        const incomeInRUB = currentCurrency === 'KGS' ? income / exchangeRate.RUB_TO_KGS : income;
        const rentInRUB = currentCurrency === 'KGS' ? rent / exchangeRate.RUB_TO_KGS : rent;
        const foodInRUB = currentCurrency === 'KGS' ? food / exchangeRate.RUB_TO_KGS : food;
        const utilitiesInRUB = currentCurrency === 'KGS' ? utilities / exchangeRate.RUB_TO_KGS : utilities;
        const otherInRUB = currentCurrency === 'KGS' ? other / exchangeRate.RUB_TO_KGS : other;
        const bankInRUB = currentCurrency === 'KGS' ? bank / exchangeRate.RUB_TO_KGS : bank;

        const totalExpensesInRUB = rentInRUB + foodInRUB + utilitiesInRUB + otherInRUB + bankInRUB;
        const balanceInRUB = incomeInRUB - totalExpensesInRUB;

        budgetData.addTransaction('income', incomeInRUB, 'income');

        const balance = convertToCurrentCurrency(balanceInRUB);
        balanceResult.dataset.amount = balanceInRUB;
        balanceResult.textContent = translations[currentLang]['balance-result']
            .replace('{amount}', formatAmount(balanceInRUB))
            .replace('{currency}', currentCurrency);
        balanceResult.className = balanceInRUB >= 0 ? 'text-success' : 'text-danger';

        if (budgetChart) {
            budgetChart.data.datasets[0].data = [
                convertToCurrentCurrency(incomeInRUB),
                convertToCurrentCurrency(totalExpensesInRUB),
                convertToCurrentCurrency(balanceInRUB)
            ];
            budgetChart.update();
        }
    });

    resetDataBtn.addEventListener('click', () => {
        if (confirm(translations[currentLang]['reset-data'] + '?')) {
            budgetData.clearData();
            incomeInput.value = '';
            expenseRentInput.value = '';
            expenseFoodInput.value = '';
            expenseUtilitiesInput.value = '';
            expenseOtherInput.value = '';
            expenseBankInput.value = '';
            balanceResult.dataset.amount = '0';
            balanceResult.textContent = translations[currentLang]['balance-result']
                .replace('{amount}', '0')
                .replace('{currency}', currentCurrency);
            balanceResult.className = '';
            goalProgressBar.style.width = '0%';
            goalProgressText.dataset.progress = '0';
            goalProgressText.textContent = translations[currentLang]['progress-text'].replace('{progress}', '0');
            forecastResult.textContent = '';
            if (budgetChart) {
                budgetChart.data.datasets[0].data = [0, 0, 0];
                budgetChart.update();
            }
            localStorage.removeItem('budgetData');
        }
    });

    setGoalBtn.addEventListener('click', () => {
        const inputs = [goalAmountInput, goalPeriodInput];
        if (!validateInputs(inputs)) return showError();
        const goalAmount = parseFloat(goalAmountInput.value) || 0;
        const goalPeriod = parseInt(goalPeriodInput.value) || 1;
        const income = parseFloat(incomeInput.value) || 0;

        const goalAmountInRUB = currentCurrency === 'KGS' ? goalAmount / exchangeRate.RUB_TO_KGS : goalAmount;
        const incomeInRUB = currentCurrency === 'KGS' ? income / exchangeRate.RUB_TO_KGS : income;

        const monthlySavingsInRUB = goalAmountInRUB / goalPeriod;
        const monthlySavings = convertToCurrentCurrency(monthlySavingsInRUB);
        const progress = incomeInRUB ? Math.min((incomeInRUB / goalAmountInRUB) * 100, 100).toFixed(2) : 0;

        goalProgressBar.style.width = `${progress}%`;
        goalProgressBar.className = incomeInRUB >= goalAmountInRUB ? 'bg-success' : 'bg-danger';
        goalProgressText.dataset.progress = progress;
        goalProgressText.textContent = translations[currentLang]['progress-text'].replace('{progress}', progress);

        const forecastPeriod = parseInt(document.getElementById('goalPeriod').value) || 1; // Используем выбранный период
        const totalSavingsNeeded = goalAmountInRUB;
        const monthlySavingsForecast = totalSavingsNeeded / forecastPeriod;
        forecastResult.dataset.amount = monthlySavingsForecast;
        forecastResult.dataset.period = forecastPeriod;
        forecastResult.textContent = translations[currentLang]['forecast-result']
            .replace('{amount}', formatAmount(monthlySavingsForecast))
            .replace('{period}', forecastPeriod)
            .replace('{currency}', currentCurrency);
    });

    currencyToggleBtn.addEventListener('click', () => {
        currentCurrency = currentCurrency === 'RUB' ? 'KGS' : 'RUB';
        localStorage.setItem('currency', currentCurrency);
        updateLanguageAndCurrency();

        const inputs = [incomeInput, expenseRentInput, expenseFoodInput, expenseUtilitiesInput, expenseOtherInput, expenseBankInput, goalAmountInput];
        inputs.forEach(input => {
            if (input.value) {
                const valueInRUB = currentCurrency === 'KGS' ? parseFloat(input.value) / exchangeRate.RUB_TO_KGS : parseFloat(input.value) * exchangeRate.KGS_TO_RUB;
                input.value = convertToCurrentCurrency(valueInRUB);
            }
        });

        if (budgetChart) {
            const incomeInRUB = parseFloat(incomeInput.value) || 0;
            const totalExpensesInRUB = (parseFloat(expenseRentInput.value) || 0) +
                                      (parseFloat(expenseFoodInput.value) || 0) +
                                      (parseFloat(expenseUtilitiesInput.value) || 0) +
                                      (parseFloat(expenseOtherInput.value) || 0) +
                                      (parseFloat(expenseBankInput.value) || 0);
            const balanceInRUB = incomeInRUB - totalExpensesInRUB;
            budgetChart.data.datasets[0].data = [
                convertToCurrentCurrency(incomeInRUB),
                convertToCurrentCurrency(totalExpensesInRUB),
                convertToCurrentCurrency(balanceInRUB)
            ];
            budgetChart.update();
        }
    });

    bankConnectBtn.addEventListener('click', () => {
        const bank = bankSelect.value;
        const accountNumber = bankAccountInput.value.trim();
        if (bank && accountNumber) {
            budgetData.addAccount(bank, accountNumber);
            alert(`${translations[currentLang]['banks-connected']}: ${bank} - ${accountNumber}`);
            bankAccountInput.value = '';
        } else {
            showError(`${translations[currentLang]['bank-select']} ${translations[currentLang]['bank-account']}`);
        }
    });

    bankSyncBtn.addEventListener('click', () => {
        const bank = bankSelect.value;
        const mockTransactions = [{ amount: 15000, category: 'bank', date: new Date() }];
        mockTransactions.forEach(tx => budgetData.addTransaction('expense', tx.amount, tx.category, tx.date));
        alert(`${translations[currentLang]['bank-sync']} ${translations[currentLang]['for']} ${bank} ${translations[currentLang]['completed']}. ${translations[currentLang]['loaded']} ${mockTransactions.length} ${translations[currentLang]['transactions']}.`);
        calculateTotalBtn.click();
    });

    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentLang = btn.dataset.lang;
            localStorage.setItem('language', currentLang);
            updateLanguageAndCurrency();

            if (budgetChart) {
                budgetChart.data.labels = [
                    translations[currentLang]['income-label'].replace(' ({currency}):', ''),
                    translations[currentLang]['manual-expenses-title'],
                    translations[currentLang]['balance-result'].split(':')[0]
                ];
                budgetChart.update();
            }
        });
    });

    const themeBtn = document.getElementById('themeToggle');
    if (themeBtn) {
        themeBtn.addEventListener('click', () => {
            console.log('Theme toggle clicked');
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme();
            localStorage.setItem('theme', currentTheme);

            if (budgetChart) {
                budgetChart.options.plugins.legend.labels.color = currentTheme === 'dark' ? '#f0f0f0' : '#333';
                budgetChart.options.plugins.tooltip.bodyColor = currentTheme === 'dark' ? '#f0f0f0' : '#333';
                budgetChart.update();
            }
        });
    } else {
        console.error('Theme toggle button not found! Check if #themeToggle exists in HTML.');
    }

    const helpBtn = document.getElementById('helpBtn');
    if (helpBtn) {
        helpBtn.addEventListener('click', () => {
            new bootstrap.Modal(document.getElementById('helpModal')).show();
        });
    }

    window.budgetData = budgetData;
});